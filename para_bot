#!/bin/bash

# para_bot, the Telegram bot written in bash.
# Written by si_kabayan

#set -o nounset
#set -o errexit
#set -o pipefail

# variables --------------------------------------------------------------------

. para_bot.conf

TG_URL='https://api.telegram.org/bot'$TOKEN
SND_MSG=$TG_URL'/sendMessage?chat_id='
GET_UPD=$TG_URL'/getUpdates?offset='
BOT_START="$(date +%s)"

for file in ./plugins/* ; do
  if [[ -f $file ]]; then
    . $file
  fi
done

# functions --------------------------------------------------------------------

send_message() {
  curl --data-urlencode "action=typing" "$TG_URL/sendChatAction?chat_id=$CHAT_ID&"
  res=$(curl --data-urlencode "text=$msg" "$SND_MSG$CHAT_ID&reply_to_message_id=$MESSAGE_ID&disable_web_page_preview=1&")
}

# main -------------------------------------------------------------------------

OFFSET="$(curl "$GET_UPD")"
OFFSET="${OFFSET##*update_id\":}"
OFFSET="${OFFSET%%,*}"

while true; do {

  set -f

  res=$(curl -g "$GET_UPD$OFFSET%26timeout=30")

  if (( ${#res} > 23 )); then
    OFFSET="${res#*\"update_id\":}"
    OFFSET="${OFFSET%%,*}"
    MESSAGE_ID="${res#*\"message_id\":}"
    MESSAGE_ID="${MESSAGE_ID%%,*}"
    USER_ID="${res#*\"id\":}"
    USER_ID="${USER_ID%%,*}"
    FIRST_NAME="${res#*\"first_name\":}"
    FIRST_NAME="${FIRST_NAME%%,*}"
    USERNAME="${res#*\"username\":}"
    USERNAME="${USERNAME%%,*}"
    CHAT_ID="${res##*\"chat\":\{\"id\":}"
    CHAT_ID="${CHAT_ID%%,*}"
    TITLE="${res#*\"title\":}"
    TITLE="${TITLE%%,*}"
    MSG_DATE="${res#*\"date\":}"
    export MSG_DATE="${MSG_DATE%%,*}"
    MESSAGE="${res##*\"text\":\"\\\/}"
    MESSAGE="${MESSAGE%%\"*}"
    MESSAGE="${MESSAGE/\\/}"
    MESSAGE="${MESSAGE/@para_bot/}"
  else
    OFFSET=
    MESSAGE_ID=
    USER_ID=
    FIRST_NAME=
    USERNAME=
    CHAT_ID=
    TITLE=
    MSG_DATE=
    MESSAGE=
    export MSG_DATE=
  fi

  OFFSET="$((OFFSET+1))"

  if [[ $OFFSET != "1" ]]; then
    if [[ $CHAT_ID > 0 || $CHAT_ID = "${ALLOWED[@]}" ]] ; then
      if [[ "$(type -t ${MESSAGE%% *})" = "function" ]]; then
        $("${MESSAGE%% *}")
      fi
    fi
  fi

  unset -f

} &>/dev/null; done
