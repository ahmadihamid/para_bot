#!/bin/bash

# para_bot, the Telegram bot written in bash.
# Written by si_kabayan

# variables --------------------------------------------------------------------

. para_bot.conf

url='https://api.telegram.org/bot'$token
sendMessage=$url'/sendMessage?chat_id='
getUpdates=$url'/getUpdates?offset='
bot_start=$(date +%s)

# functions --------------------------------------------------------------------

for file in ./plugins/*
do
  if [[ -f $file ]]
  then
    . $file
  fi
done

function send_message {
  curl --data-urlencode "action=typing" "$url/sendChatAction?chat_id=$chat_id&"
  res=$(curl --data-urlencode "text=$msg" "$sendMessage$chat_id&reply_to_message_id=$message_id&disable_web_page_preview=1&")
}

# main -------------------------------------------------------------------------

offset=$(curl "$getUpdates")
offset=${offset##*update_id\":}
offset=${offset%%,*}

while true; do {

  set -f

  res=$(curl -g "$getUpdates$offset%26timeout=20")

  if [[ ${#res} > 23 ]]
  then
    offset=${res#*\"update_id\":}
    offset=${offset%%,*}
    message_id=${res#*\"message_id\":}
    message_id=${message_id%%,*}
    user_id=${res#*\"id\":}
    user_id=${user_id%%,*}
    first_name=${res#*\"first_name\":}
    first_name=${first_name%%,*}
    username=${res#*\"username\":}
    username=${username%%,*}
    chat_id=${res##*\"chat\":\{\"id\":}
    chat_id=${chat_id%%,*}
    title=${res#*\"title\":}
    title=${title%%,*}
    msg_date=${res#*\"date\":}
    msg_date=${msg_date%%,*}
    message=${res##*\"text\":\"\\}
    message=${message%%\"*}
    message=${message/\\/}
    message=${message/@para_bot/}
    unix_date=${res##*date\":}
    export unix_date=${unix_date%%,*}
  else
    offset=
    message_id=
    user_id=
    first_name=
    username=
    chat_id=
    title=
    msg_date=
    message=
    export unix_date=
  fi

  offset=$((offset+1))

  if [[ $offset != 1 ]] && [[ $chat_id = ${allowed[0]} ]] || [[ $chat_id = ${allowed[1]} ]]
  then
    case "${message%% *}" in
      '/adzan')
        adzan
      ;;
      '/calc')
        calc
      ;;
      '/cuaca')
        cuaca
      ;;
      '/ddg')
        duckduckgo
      ;;
      '/echo')
        gema
      ;;
      '/help')
        help
      ;;
      '/info')
        msg='This is para_bot, the Telegram bot written in bash.'
      ;;
      '/jam')
        jam
      ;;
      '/kamus')
        kamus
      ;;
    esac
  fi

} &>/dev/null; done
